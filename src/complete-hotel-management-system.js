// ===== ระบบจัดการโรงแรมเต็มรูปแบบ =====

function สร้างระบบจัดการโรงแรมครบวงจร() {
  
  // ===== 1. ข้อมูลส่วนบุคคล =====
  สร้างชีต('ข้อมูลลูกค้า', [
    'รหัสลูกค้า', 'ชื่อ-นามสกุล', 'เลขบัตรประชาชน', 'เบอร์โทร', 'อีเมล', 
    'ที่อยู่', 'ประเภทลูกค้า', 'วันที่สมัคร', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('ข้อมูลพนักงาน', [
    'รหัสพนักงาน', 'ชื่อ-นามสกุล', 'ตำแหน่ง', 'เงินเดือน', 'วันที่เริ่มงาน',
    'เบอร์โทร', 'ที่อยู่', 'เลขบัญชี', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('ข้อมูลบริษัท', [
    'รหัสบริษัท', 'ชื่อบริษัท', 'เลขผู้เสียภาษี', 'ที่อยู่', 'ผู้ติดต่อ',
    'เบอร์โทร', 'อีเมล', 'เงื่อนไขการชำระ', 'สถานะ', 'หมายเหตุ'
  ]);

  // ===== 2. ระบบการบัญชีและการเงิน =====
  สร้างชีต('รายรับห้องพักรายวัน', [
    'วันที่', 'รหัสการจอง', 'รหัสห้อง', 'รหัสลูกค้า', 'ราคาห้อง', 
    'ค่าบริการเพิ่มเติม', 'ยอดรวม', 'วิธีชำระ', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('รายรับห้องพักรายเดือน', [
    'เดือน/ปี', 'รหัสห้อง', 'รหัสผู้เช่า', 'ค่าเช่าพื้นฐาน', 'มิเตอร์ไฟเก่า',
    'มิเตอร์ไฟใหม่', 'หน่วยใช้ไฟ', 'ค่าไฟ', 'มิเตอร์น้ำเก่า', 'มิเตอร์น้ำใหม่',
    'หน่วยใช้น้ำ', 'ค่าน้ำ', 'ค่าบริการอื่น', 'ยอดรวม', 'สถานะชำระ'
  ]);
  
  สร้างชีต('รายรับบ้านเช่า', [
    'เดือน/ปี', 'รหัสบ้าน', 'รหัสผู้เช่า', 'ค่าเช่า', 'วันที่ชำระ',
    'วิธีชำระ', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('รายจ่ายประจำวัน', [
    'วันที่', 'รหัสรายจ่าย', 'หมวดรายจ่าย', 'รายละเอียด', 'จำนวนเงิน',
    'ผู้อนุมัติ', 'ใบเสร็จ/บิล', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('รายจ่ายประจำเดือน', [
    'เดือน/ปี', 'ประเภทรายจ่าย', 'รายละเอียด', 'จำนวนเงิน', 'วันที่จ่าย',
    'ผู้รับเงิน', 'เอกสารอ้างอิง', 'สถานะ', 'หมายเหตุ'
  ]);

  // ===== 3. ข้อมูลองค์กรและประวัติ =====
  สร้างชีต('ข้อมูลห้องพัก', [
    'รหัสห้อง', 'ประเภทห้อง', 'ราคารายวัน', 'ราคารายเดือน', 'ขนาดห้อง',
    'สิ่งอำนวยความสะดวก', 'สถานะห้อง', 'ผู้เช่าปัจจุบัน', 'วันที่เข้าพัก', 'หมายเหตุ'
  ]);
  
  สร้างชีต('ข้อมูลบ้านเช่า', [
    'รหัสบ้าน', 'ที่อยู่', 'ขนาด', 'ราคาเช่า', 'ผู้เช่าปัจจุบัน',
    'วันที่เริ่มเช่า', 'วันที่สิ้นสุดสัญญา', 'สถานะ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('ข้อมูลการจดทะเบียน', [
    'ประเภทใบอนุญาต', 'เลขที่ใบอนุญาต', 'วันที่ออก', 'วันหมดอายุ',
    'หน่วยงานออก', 'สถานะ', 'ไฟล์เอกสาร', 'หมายเหตุ'
  ]);
  
  สร้างชีต('ข้อมูลองค์กร', [
    'ชื่อธุรกิจ', 'เลขผู้เสียภาษี', 'ที่อยู่', 'เบอร์โทร', 'อีเมล',
    'เว็บไซต์', 'Google Map Link', 'ประวัติการก่อตั้ง', 'ผู้บริหาร', 'หมายเหตุ'
  ]);

  // ===== 4. Data Contact ID (ระบบเชื่อมโยงข้อมูล) =====
  สร้างชีต('ตารางID_Master', [
    'ประเภทID', 'รหัสID', 'คำอธิบาย', 'ตารางที่เชื่อมโยง', 'สถานะใช้งาน',
    'วันที่สร้าง', 'ผู้สร้าง', 'วันที่แก้ไขล่าสุด', 'หมายเหตุ'
  ]);
  
  สร้างชีต('การเชื่อมโยงข้อมูล', [
    'ID_หลัก', 'ID_เชื่อมโยง', 'ประเภทความสัมพันธ์', 'ตารางต้นทาง',
    'ตารางปลายทาง', 'สถานะ', 'วันที่เชื่อมโยง', 'หมายเหตุ'
  ]);

  // ===== 5. การจัดการงานเอกสาร =====
  สร้างชีต('ใบเสร็จค่าห้องพัก', [
    'เลขที่ใบเสร็จ', 'วันที่ออก', 'รหัสลูกค้า', 'รหัสห้อง', 'รายการ',
    'จำนวนเงิน', 'ภาษี', 'ยอดรวม', 'ผู้ออกใบเสร็จ', 'ไฟล์PDF'
  ]);
  
  สร้างชีต('ใบแจ้งหนี้รายเดือน', [
    'เลขที่ใบแจ้งหนี้', 'เดือน/ปี', 'รหัสผู้เช่า', 'รหัสห้อง/บ้าน',
    'รายการค่าใช้จ่าย', 'ยอดรวม', 'วันครบกำหนด', 'สถานะ', 'ไฟล์PDF'
  ]);
  
  สร้างชีต('สัญญาเช่า', [
    'เลขที่สัญญา', 'ประเภทสัญญา', 'รหัสผู้เช่า', 'รหัสห้อง/บ้าน',
    'วันที่เริ่มสัญญา', 'วันที่สิ้นสุด', 'ค่าเช่า', 'เงินประกัน', 'สถานะ', 'ไฟล์PDF'
  ]);
  
  สร้างชีต('เอกสารเทศบาล', [
    'ประเภทเอกสาร', 'เดือน/ปี', 'จำนวนผู้เข้าพัก', 'วันที่ส่ง',
    'หน่วยงานรับ', 'สถานะ', 'ไฟล์เอกสาร', 'หมายเหตุ'
  ]);

  // ===== 6. การติดตามงานประจำเดือน =====
  สร้างชีต('การชำระค่าสาธารณูปโภค', [
    'เดือน/ปี', 'ประเภท', 'หมายเลขผู้ใช้', 'หน่วยใช้', 'จำนวนเงิน',
    'วันครบกำหนด', 'วันที่ชำระ', 'สถานะ', 'ใบเสร็จ', 'หมายเหตุ'
  ]);
  
  สร้างชีต('การเก็บค่าเช่าประจำเดือน', [
    'เดือน/ปี', 'รหัสห้อง/บ้าน', 'รหัสผู้เช่า', 'ยอดค่าเช่า',
    'วันที่เก็บ', 'จำนวนที่เก็บได้', 'คงเหลือ', 'สถานะ', 'หมายเหตุ'
  ]);

  // ===== 7. บันทึกประวัติการทำงาน =====
  สร้างชีต('ประวัติการทำงานรายเดือน', [
    'เดือน/ปี', 'กิจกรรม', 'รายละเอียด', 'ผู้รับผิดชอบ', 'สถานะ',
    'วันที่เริ่ม', 'วันที่เสร็จ', 'ผลลัพธ์', 'หมายเหตุ'
  ]);

  // ===== 8. การจัดการไฟล์และรูปภาพ =====
  สร้างชีต('ไฟล์สลิปการชำระ', [
    'รหัสไฟล์', 'วันที่', 'ประเภท', 'รหัสอ้างอิง', 'ชื่อไฟล์',
    'โฟลเดอร์', 'ขนาดไฟล์', 'ผู้อัพโหลด', 'สถานะ', 'URL'
  ]);
  
  สร้างชีต('ไฟล์บิลค่าใช้จ่าย', [
    'รหัสไฟล์', 'วันที่', 'ประเภทค่าใช้จ่าย', 'รหัสรายจ่าย', 'ชื่อไฟล์',
    'โฟลเดอร์', 'จำนวนเงิน', 'ผู้อัพโหลด', 'สถานะ', 'URL'
  ]);

  // ===== 9. ระบบควบคุมกลาง =====
  สร้างชีต('ระบบควบคุมกลาง', [
    'ชื่อชีต', 'สถานะ', 'จำนวนข้อมูล', 'อัพเดทล่าสุด', 'ผู้รับผิดชอบ',
    'การเชื่อมโยง', 'สูตรImport', 'หมายเหตุ'
  ]);

  console.log('สร้างระบบจัดการโรงแรมเต็มรูปแบบเรียบร้อย');
}

// ===== ระบบสร้าง ID อัตโนมัติ =====
function สร้างIDอัตโนมัติ(ประเภท) {
  const วันนี้ = new Date();
  const ปี = วันนี้.getFullYear().toString().slice(-2);
  const เดือน = (วันนี้.getMonth() + 1).toString().padStart(2, '0');
  const วัน = วันนี้.getDate().toString().padStart(2, '0');
  
  const รูปแบบID = {
    'ลูกค้า': `CUS${ปี}${เดือน}${วัน}`,
    'พนักงาน': `EMP${ปี}${เดือน}${วัน}`,
    'ห้องพัก': `RM${ปี}${เดือน}${วัน}`,
    'การจอง': `BK${ปี}${เดือน}${วัน}`,
    'ใบเสร็จ': `RC${ปี}${เดือน}${วัน}`,
    'ใบแจ้งหนี้': `INV${ปี}${เดือน}${วัน}`,
    'สัญญา': `CT${ปี}${เดือน}${วัน}`,
    'รายจ่าย': `EX${ปี}${เดือน}${วัน}`
  };
  
  const baseID = รูปแบบID[ประเภท] || `GEN${ปี}${เดือน}${วัน}`;
  const เลขลำดับ = หาเลขลำดับถัดไป(ประเภท, baseID);
  
  return `${baseID}${เลขลำดับ.toString().padStart(3, '0')}`;
}

// ===== ระบบเชื่อมโยงข้อมูล =====
function เชื่อมโยงข้อมูล(IDหลัก, IDเชื่อมโยง, ประเภทความสัมพันธ์) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const การเชื่อมโยง = ss.getSheetByName('การเชื่อมโยงข้อมูล');
  
  การเชื่อมโยง.appendRow([
    IDหลัก,
    IDเชื่อมโยง,
    ประเภทความสัมพันธ์,
    หาตารางจากID(IDหลัก),
    หาตารางจากID(IDเชื่อมโยง),
    'ใช้งาน',
    new Date(),
    'ระบบอัตโนมัติ'
  ]);
}

// ===== ระบบคำนวณค่าสาธารณูปโภค =====
function คำนวณค่าไฟน้ำ(รหัสห้อง, มิเตอร์เก่า, มิเตอร์ใหม่, ประเภท) {
  const หน่วยใช้ = มิเตอร์ใหม่ - มิเตอร์เก่า;
  
  const อัตราค่าไฟ = [
    { ขั้น: 150, ราคา: 3.2734 },
    { ขั้น: 250, ราคา: 4.2218 },
    { ขั้น: 999999, ราคา: 4.4217 }
  ];
  
  const อัตราค่าน้ำ = [
    { ขั้น: 8, ราคา: 8.50 },
    { ขั้น: 20, ราคา: 9.50 },
    { ขั้น: 30, ราคา: 10.50 },
    { ขั้น: 999999, ราคา: 11.50 }
  ];
  
  let ค่าใช้จ่าย = 0;
  let หน่วยคงเหลือ = หน่วยใช้;
  const อัตรา = ประเภท === 'ไฟ' ? อัตราค่าไฟ : อัตราค่าน้ำ;
  
  for (const ขั้น of อัตรา) {
    if (หน่วยคงเหลือ <= 0) break;
    
    const หน่วยในขั้น = Math.min(หน่วยคงเหลือ, ขั้น.ขั้น);
    ค่าใช้จ่าย += หน่วยในขั้น * ขั้น.ราคา;
    หน่วยคงเหลือ -= หน่วยในขั้น;
  }
  
  return Math.round(ค่าใช้จ่าย * 100) / 100;
}

// ===== ระบบสร้างเอกสาร PDF =====
function สร้างใบเสร็จPDF(ข้อมูลใบเสร็จ) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // สร้างชีตชั่วคราวสำหรับใบเสร็จ
  const ใบเสร็จTemp = ss.insertSheet('ใบเสร็จ_' + ข้อมูลใบเสร็จ.เลขที่);
  
  // จัดรูปแบบใบเสร็จ
  ใบเสร็จTemp.getRange('A1').setValue('ใบเสร็จรับเงิน');
  ใบเสร็จTemp.getRange('A2').setValue(`เลขที่: ${ข้อมูลใบเสร็จ.เลขที่}`);
  ใบเสร็จTemp.getRange('A3').setValue(`วันที่: ${ข้อมูลใบเสร็จ.วันที่}`);
  ใบเสร็จTemp.getRange('A4').setValue(`ลูกค้า: ${ข้อมูลใบเสร็จ.ลูกค้า}`);
  ใบเสร็จTemp.getRange('A5').setValue(`รายการ: ${ข้อมูลใบเสร็จ.รายการ}`);
  ใบเสร็จTemp.getRange('A6').setValue(`จำนวนเงิน: ${ข้อมูลใบเสร็จ.จำนวนเงิน} บาท`);
  
  // สร้าง PDF URL
  const url = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?format=pdf&gid=${ใบเสร็จTemp.getSheetId()}`;
  
  // ลบชีตชั่วคราว
  ss.deleteSheet(ใบเสร็จTemp);
  
  return url;
}

// ===== ระบบจัดการโฟลเดอร์อัตโนมัติ =====
function สร้างโฟลเดอร์ตามวันที่(ประเภท) {
  const วันนี้ = new Date();
  const ปี = วันนี้.getFullYear();
  const เดือน = (วันนี้.getMonth() + 1).toString().padStart(2, '0');
  const วัน = วันนี้.getDate().toString().padStart(2, '0');
  
  const ชื่อโฟลเดอร์ = `${ประเภท}_${ปี}${เดือน}${วัน}`;
  
  try {
    // ตรวจสอบว่ามีโฟลเดอร์อยู่แล้วหรือไม่
    const โฟลเดอร์ที่มี = DriveApp.getFoldersByName(ชื่อโฟลเดอร์);
    
    if (โฟลเดอร์ที่มี.hasNext()) {
      return โฟลเดอร์ที่มี.next();
    } else {
      return DriveApp.createFolder(ชื่อโฟลเดอร์);
    }
  } catch (error) {
    console.log('ไม่สามารถสร้างโฟลเดอร์ได้:', error);
    return null;
  }
}

// ===== API ระบบจัดการโรงแรมเต็มรูปแบบ =====
function doPost(e) {
  try {
    const ข้อมูล = JSON.parse(e.postData.contents);
    const การกระทำ = ข้อมูล.การกระทำ;
    
    switch (การกระทำ) {
      case 'สร้างIDใหม่':
        const IDใหม่ = สร้างIDอัตโนมัติ(ข้อมูล.ประเภท);
        return ตอบกลับ(true, 'สร้าง ID สำเร็จ', {}, { ID: IDใหม่ });
        
      case 'คำนวณค่าสาธารณูปโภค':
        const ค่าใช้จ่าย = คำนวณค่าไฟน้ำ(
          ข้อมูล.รหัสห้อง,
          ข้อมูล.มิเตอร์เก่า,
          ข้อมูล.มิเตอร์ใหม่,
          ข้อมูล.ประเภท
        );
        return ตอบกลับ(true, 'คำนวณเรียบร้อย', {}, { ค่าใช้จ่าย });
        
      case 'สร้างใบเสร็จ':
        const URLใบเสร็จ = สร้างใบเสร็จPDF(ข้อมูล.ข้อมูลใบเสร็จ);
        return ตอบกลับ(true, 'สร้างใบเสร็จสำเร็จ', {}, { URL: URLใบเสร็จ });
        
      case 'เชื่อมโยงข้อมูล':
        เชื่อมโยงข้อมูล(ข้อมูล.IDหลัก, ข้อมูล.IDเชื่อมโยง, ข้อมูล.ประเภท);
        return ตอบกลับ(true, 'เชื่อมโยงข้อมูลสำเร็จ');
        
      default:
        return doPostOriginal(e);
    }
    
  } catch (error) {
    return ตอบกลับ(false, 'เกิดข้อผิดพลาด', {}, error.toString());
  }
}

// ===== ฟังก์ชันช่วย =====
function หาเลขลำดับถัดไป(ประเภท, baseID) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ตารางID = ss.getSheetByName('ตารางID_Master');
  const data = ตารางID.getDataRange().getValues();
  
  let เลขสูงสุด = 0;
  data.forEach(row => {
    if (row[1] && row[1].startsWith(baseID)) {
      const เลขลำดับ = parseInt(row[1].slice(-3));
      if (เลขลำดับ > เลขสูงสุด) เลขสูงสุด = เลขลำดับ;
    }
  });
  
  return เลขสูงสุด + 1;
}

function หาตารางจากID(ID) {
  const คำนำหน้า = ID.substring(0, 3);
  const แมพตาราง = {
    'CUS': 'ข้อมูลลูกค้า',
    'EMP': 'ข้อมูลพนักงาน',
    'RM': 'ข้อมูลห้องพัก',
    'BK': 'รายรับห้องพักรายวัน',
    'RC': 'ใบเสร็จค่าห้องพัก',
    'INV': 'ใบแจ้งหนี้รายเดือน',
    'CT': 'สัญญาเช่า',
    'EX': 'รายจ่ายประจำวัน'
  };
  
  return แมพตาราง[คำนำหน้า] || 'ไม่ระบุ';
}
