#!/usr/bin/env python3
"""
‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° SQLite
"""
import sqlite3
import sys
import datetime
import random

def ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•():
    """‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"""
    return sqlite3.connect('database/data/‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°.db')

def generate_id(prefix):
    """‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (e.g., RES-20260122-001)"""
    today = datetime.datetime.now().strftime("%Y%m%d")
    random_suffix = "".join([str(random.randint(0, 9)) for _ in range(3)])
    return f"{prefix}-{today}-{random_suffix}"

def ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î():
    """‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"""
    conn = ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•()
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    tables = cursor.fetchall()
    conn.close()
    
    print("üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:")
    for (table_name,) in tables:
        print(f"   ‚Ä¢ {table_name}")

def ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å():
    """‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å"""
    conn = ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å")
    guests = cursor.fetchall()
    conn.close()
    
    print("üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:")
    for guest in guests:
        print(f"   ‡∏£‡∏´‡∏±‡∏™ {guest[0]}: {guest[1]} | {guest[2]} | ‡∏´‡πâ‡∏≠‡∏á {guest[4]} | {guest[5]} ‚Üí {guest[6]}")

def ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å():
    """‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å"""
    conn = ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT h.‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á, h.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, h.‡∏£‡∏≤‡∏Ñ‡∏≤, h.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, p.‡∏ä‡∏∑‡πà‡∏≠
        FROM ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å h
        LEFT JOIN ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å p ON h.‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å = p.‡∏£‡∏´‡∏±‡∏™
        ORDER BY h.‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á
    ''')
    rooms = cursor.fetchall()
    conn.close()
    
    print("üè† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å:")
    for room in rooms:
        guest_info = f" | {room[4]}" if room[4] else ""
        print(f"   ‡∏´‡πâ‡∏≠‡∏á {room[0]}: {room[1]} ({room[2]:,}‡∏ø) - {room[3]}{guest_info}")

def ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥():
    """‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°"""
    conn = ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•()
    cursor = conn.cursor()
    
    # ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å
    cursor.execute("SELECT COUNT(*) FROM ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å")
    total_rooms = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å WHERE ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ = '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å'")
    occupied_rooms = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(*) FROM ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å WHERE ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å'")
    total_guests = cursor.fetchone()[0]
    
    # ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á
    cursor.execute('''
        SELECT ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, COUNT(*) as ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, 
               SUM(CASE WHEN ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ = '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å' THEN 1 ELSE 0 END) as ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å,
               AVG(‡∏£‡∏≤‡∏Ñ‡∏≤) as ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        FROM ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å 
        GROUP BY ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    ''')
    room_stats = cursor.fetchall()
    
    conn.close()
    
    print("üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°:")
    print(f"   üè† ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {total_rooms} ‡∏´‡πâ‡∏≠‡∏á")
    print(f"   üî¥ ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å: {occupied_rooms} ‡∏´‡πâ‡∏≠‡∏á ({occupied_rooms/total_rooms*100:.1f}%)")
    print(f"   üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {total_guests} ‡∏Ñ‡∏ô")
    print()
    print("üìã ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á:")
    for ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å, ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ in room_stats:
        print(f"   {‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó}: {‡∏à‡∏≥‡∏ô‡∏ß‡∏ô} ‡∏´‡πâ‡∏≠‡∏á | ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å {‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å} ‡∏´‡πâ‡∏≠‡∏á | ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ {‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:,.0f}‡∏ø")

def ‡∏£‡∏±‡∏ô_SQL(sql):
    """‡∏£‡∏±‡∏ô SQL query"""
    conn = ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•()
    cursor = conn.cursor()
    
    try:
        cursor.execute(sql)
        results = cursor.fetchall()
        
        if results:
            print(f"üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ({len(results)} ‡πÅ‡∏ñ‡∏ß):")
            for i, row in enumerate(results, 1):
                print(f"   {i}: {row}")
        else:
            print("‚úÖ SQL executed successfully (no results)")
            
    except Exception as e:
        print(f"‚ùå Error: {e}")
    
    conn.close()

def ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å():
    """‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å"""
    print("üè® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° SQLite")
    print("=" * 40)
    print("1. ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
    print("2. ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å")
    print("3. ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å")
    print("4. ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°")
    print("5. ‡∏£‡∏±‡∏ô SQL Query")
    print("6. ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°")
    print()

if __name__ == "__main__":
    if len(sys.argv) > 1:
        # ‡∏£‡∏±‡∏ô command line
        command = sys.argv[1]
        
        if command == "tables":
            ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î()
        elif command == "guests":
            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å()
        elif command == "rooms":
            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å()
        elif command == "stats":
            ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥()
        elif command == "sql" and len(sys.argv) > 2:
            ‡∏£‡∏±‡∏ô_SQL(" ".join(sys.argv[2:]))
        else:
            print("Usage:")
            print("  python3 db_access.py tables    # ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
            print("  python3 db_access.py guests    # ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å")
            print("  python3 db_access.py rooms     # ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å")
            print("  python3 db_access.py stats     # ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥")
            print("  python3 db_access.py sql 'SELECT * FROM ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å'")
    else:
        # ‡∏£‡∏±‡∏ô interactive mode
        while True:
            ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å()
            choice = input("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π (1-6): ").strip()
            
            if choice == "1":
                ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î()
            elif choice == "2":
                ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å()
            elif choice == "3":
                ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å()
            elif choice == "4":
                ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥()
            elif choice == "5":
                sql = input("‡∏û‡∏¥‡∏°‡∏û‡πå SQL Query: ").strip()
                if sql:
                    ‡∏£‡∏±‡∏ô_SQL(sql)
            elif choice == "6":
                print("üëã ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
                break
            else:
                print("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π 1-6")
            
            print()
            input("‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠...")
            print("\n" + "="*50 + "\n")
